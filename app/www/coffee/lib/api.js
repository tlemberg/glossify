// Generated by CoffeeScript 1.9.1
(function() {
  define(['utils', 'storage'], function(utils, storage) {
    var URL_BASE, _addLanguage, _apiUrl, _authenticateUser, _createUser, _ensureDictionary, _fetchDictionary, _updateUserProfile;
    URL_BASE = 'http://52.10.65.123:5000/api/';
    _apiUrl = function(url, authenticated, params) {
      var k, paramStr, v;
      params || (params = {});
      if (authenticated) {
        params['email'] = storage.getUserProfile()['email'];
        params['auth_token'] = storage.getAccessToken();
      }
      paramStr = ((function() {
        var results;
        results = [];
        for (k in params) {
          v = params[k];
          results.push(k + "=" + v);
        }
        return results;
      })()).join('&');
      if (paramStr) {
        return "" + URL_BASE + url + "?" + paramStr;
      } else {
        return "" + URL_BASE + url;
      }
    };
    _createUser = function(email, password, handler) {
      return $.ajax({
        url: _apiUrl('create-user'),
        method: "POST",
        data: {
          email: email,
          password: password
        },
        dataType: 'json',
        success: function(json) {
          return handler(json);
        }
      });
    };
    _authenticateUser = function(email, password, handler) {
      return $.ajax({
        url: _apiUrl('authenticate-user'),
        method: "POST",
        data: {
          email: email,
          password: password
        },
        dataType: 'json',
        success: function(json) {
          if (json['success']) {
            storage.setAccessToken(json['result']['token']);
            storage.setUserProfile(json['result']['userProfile']);
          }
          return handler(json);
        }
      });
    };
    _fetchDictionary = function(lang, handler) {
      var token;
      token = storage.getAccessToken();
      return $.ajax({
        url: "http://52.10.65.123:5000/api/get-dictionary/" + lang + "?auth_token=" + token,
        dataType: 'json',
        success: function(json) {
          var dictionary;
          if (json['success'] === 1) {
            dictionary = json['result'];
            storage.setDictionary(lang, dictionary);
          }
          return handler(json);
        }
      });
    };
    _ensureDictionary = function(lang, handler) {
      var dictionary;
      dictionary = storage.getDictionary(lang);
      if (dictionary != null) {
        return handler({
          success: 1,
          result: dictionary
        });
      } else {
        return fetchDictionary(lang, handler);
      }
    };
    _updateUserProfile = function(handler) {
      var email, token, userProfile;
      userProfile = storage.getUserProfile();
      email = userProfile['email'];
      token = storage.getAccessToken();
      return $.ajax({
        url: "http://52.10.65.123:5000/api/update-progress/" + email + "?auth_token=" + token,
        method: 'post',
        data: {
          cards: cards
        },
        dataType: 'json',
        success: function(json) {
          var dictionary;
          if (json['success'] === 1) {
            dictionary = json['result'];
          }
          return handler(json);
        }
      });
    };
    _addLanguage = function(lang, handler) {
      var authenticated;
      return $.ajax({
        url: _apiUrl("add-language/" + lang, authenticated = true),
        dataType: 'json',
        success: function(json) {
          return handler(json);
        }
      });
    };
    return {
      createUser: function(email, password, handler) {
        return _createUser(email, password, handler);
      },
      authenticateUser: function(email, password, handler) {
        return _authenticateUser(email, password, handler);
      },
      addLanguage: function(lang, handler) {
        return _addLanguage(lang, handler);
      },
      fetchDictionary: function(lang, handler) {
        return _fetchDictionary(lang, handler);
      },
      ensureDictionary: function(lang, handler) {
        return _ensureDictionary(lang, handler);
      },
      updateUserProfile: function(handler) {
        return _updateUserProfile(handler);
      },
      apiSummary: function() {
        return {
          'createUser': {
            func: this.createUser,
            params: ['email', 'password']
          },
          'authenticateUser': {
            func: this.authenticateUser,
            params: ['email', 'password']
          },
          'addLanguage': {
            func: this.addLanguage,
            params: ['lang']
          },
          'fetchDictionary': {
            func: this.fetchDictionary,
            params: ['lang']
          },
          'updateUserProfile': {
            func: this.updateUserProfile,
            params: []
          }
        };
      }
    };
  });

}).call(this);
