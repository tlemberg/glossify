// Generated by CoffeeScript 1.9.2
(function() {
  var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  define(['utils', 'storage', 'nav', 'css', 'deck', 'stack', 'hbs!../../hbs/src/box-list'], function(utils, storage, nav, css, deck, stack, boxListTemplate) {
    var PICKER_TILE_MARGIN, _createEmptyProgress, _loadBoxList, _loadNavHeader, _loadPage, _nav, _refreshPage, _registerEvents, _setPickerHtml;
    _nav = void 0;
    PICKER_TILE_MARGIN = 10;
    _loadPage = function(template) {
      var dictionary, lang, templateArgs, userProfile;
      lang = storage.getLanguage();
      userProfile = storage.getUserProfile();
      if (indexOf.call(Object.keys(userProfile['langs']), lang) < 0) {
        _createEmptyProgress();
      }
      if (storage.getSection() == null) {
        storage.setSection(1);
      }
      userProfile = storage.getUserProfile();
      dictionary = storage.getDictionary(lang);
      templateArgs = {
        sections: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      };
      $(".overview-page").html(template(templateArgs));
      _loadBoxList(false);
      _loadNavHeader();
      _nav.showBackBtn("Logout", function(event) {
        storage.logout();
        return _nav.loadPage('login');
      });
      if (!userProfile['confirmed']) {
        _nav.showAlert("You will need to check your email to confirm your email address and fully activate yout account.");
      }
      return _registerEvents();
    };
    _refreshPage = function() {
      return console.log('refresh');
    };
    _loadNavHeader = function() {
      var maxIndex, minIndex, s, section, sectionInterval;
      section = storage.getSection();
      sectionInterval = stack.getSectionInterval(section);
      minIndex = sectionInterval['min'] + 1;
      maxIndex = sectionInterval['max'] + 1;
      s = "Cards " + minIndex + " through " + maxIndex;
      if (section === 1) {
        $('.overview-page .arrow-btn-left').hide();
        $('.overview-page .arrow-btn-right').show();
      } else if (section === 10) {
        $('.overview-page .arrow-btn-left').show();
        $('.overview-page .arrow-btn-right').hide();
      } else {
        $('.overview-page .arrow-btn-left').show();
        $('.overview-page .arrow-btn-right').show();
      }
      return $(".overview-page .interval-text").html(s);
    };
    _loadBoxList = function(transition) {
      var dictionary, lang, matchHeight, matchWidth, plan, section, templateArgs, userProfile;
      if (transition == null) {
        transition = true;
      }
      userProfile = storage.getUserProfile();
      lang = storage.getLanguage();
      dictionary = storage.getDictionary(lang);
      section = storage.getSection();
      plan = storage.getPlan(lang);
      templateArgs = {
        boxes: stack.getBoxes(plan, dictionary, section, lang, 100)
      };
      $(".overview-page .box-list-" + section).html(boxListTemplate(templateArgs));
      $(".overview-page .box-list-" + section).css("width", utils.withUnit(utils.windowWidth(), 'px'));
      $(".overview-page .box-list-container").css("width", utils.withUnit(utils.windowWidth() * 10, 'px'));
      matchWidth = $(".overview-page .box-list-" + section).css("width");
      matchHeight = $(".overview-page .box-list-" + section).css("height");
      $(".overview-page .box-list").css("width", matchWidth);
      $(".overview-page .box-list").css("height", matchHeight);
      $(".box-list-container .box-div").off('click');
      $(".box-list-" + section + " .box-div").click(function(event) {
        var index;
        index = $(this).data('index');
        storage.setBox(index);
        return _nav.loadPage('study');
      });
      if (transition) {
        return $(".box-list-container").animate({
          "margin-left": utils.withUnit(-1 * (section - 1) * utils.windowWidth(), 'px')
        }, 500, function() {
          return console.log("animate");
        });
      } else {
        return $(".box-list-container").css("margin-left", utils.withUnit(-1 * (section - 1) * utils.windowWidth(), 'px'));
      }
    };
    _setPickerHtml = function() {
      var allBlocksHtml, allRowDivsHtml, boxCards, boxIndex, boxProgress, boxes, card, containerDivHtml, containerDivs, dictionary, i, j, k, l, lang, len, len1, len2, maxIndex, maxSampleIndex, minIndex, minSampleIndex, nBoxes, pickerHtml, progress, progressList, ref, ref1, ref2, ref3, rowDivHtml, rowDivs, sampleCards, sampleStr, sampleWords, section, userProfile;
      section = storage.getSection();
      lang = storage.getLanguage();
      userProfile = storage.getUserProfile();
      dictionary = storage.getDictionary(lang);
      minIndex = (section - 1) * 1000;
      maxIndex = section * 1000 - 1;
      boxes = {};
      nBoxes = deck.pageSize() / deck.boxSize();
      for (boxIndex = i = 0, ref = nBoxes - 1; 0 <= ref ? i <= ref : i >= ref; boxIndex = 0 <= ref ? ++i : --i) {
        minIndex = (section - 1) * deck.boxSize() + boxIndex * deck.boxSize();
        maxIndex = minIndex + deck.boxSize();
        boxCards = userProfile['langs'][lang].slice(minIndex, maxIndex);
        for (j = 0, len = boxCards.length; j < len; j++) {
          card = boxCards[j];
          progressList = parseInt(card['progress']);
        }
        boxProgress = Math.min(progressList);
        if (ref1 = boxProgress.toString(), indexOf.call(Object.keys(boxes), ref1) < 0) {
          boxes[boxProgress] = [];
        }
        boxes[boxProgress].push(boxIndex);
      }
      containerDivs = [];
      ref2 = Object.keys(boxes);
      for (k = 0, len1 = ref2.length; k < len1; k++) {
        progress = ref2[k];
        rowDivs = [];
        ref3 = boxes[progress];
        for (l = 0, len2 = ref3.length; l < len2; l++) {
          boxIndex = ref3[l];
          minSampleIndex = (section - 1) * deck.pageSize() + boxIndex * deck.boxSize();
          maxSampleIndex = minSampleIndex + 3;
          sampleCards = userProfile['langs'][lang].slice(minSampleIndex, maxSampleIndex);
          sampleWords = (function() {
            var len3, m, results;
            results = [];
            for (m = 0, len3 = sampleCards.length; m < len3; m++) {
              card = sampleCards[m];
              results.push(dictionary['dictionary'][card['phrase_id']]['base']);
            }
            return results;
          })();
          sampleStr = sampleWords.join(', ') + "...";
          rowDivHtml = "<a class='overview-block-row-link' data-index=" + boxIndex + "><div class='overview-block-row'>\n	<div class='overview-block-sample'>" + sampleStr + "</div>\n</div>";
          rowDivs.push(rowDivHtml);
        }
        allRowDivsHtml = rowDivs.join('');
        containerDivHtml = "<div class='overview-block'>\n	<div class='overview-block-header'>\n		HEADER\n	</div>\n	" + allRowDivsHtml + "\n</div>";
        containerDivs.push(containerDivHtml);
      }
      allBlocksHtml = containerDivs.join('');
      pickerHtml = "" + allBlocksHtml;
      $('#overview-content').html(pickerHtml);
      return _nav.refreshPage();
    };
    _registerEvents = function() {
      $('.overview-page .arrow-btn-left').click(function(event) {
        storage.setSection(storage.getSection() - 1);
        _loadBoxList();
        return _loadNavHeader();
      });
      return $('.overview-page .arrow-btn-right').click(function(event) {
        storage.setSection(storage.getSection() + 1);
        _loadBoxList();
        return _loadNavHeader();
      });
    };
    _createEmptyProgress = function() {
      var dictionary, i, lang, len, phraseId, phrases, ref, userProfile;
      lang = storage.getLanguage();
      dictionary = storage.getDictionary(lang);
      userProfile = storage.getUserProfile();
      phrases = [];
      ref = Object.keys(dictionary['dictionary']);
      for (i = 0, len = ref.length; i < len; i++) {
        phraseId = ref[i];
        phrases.push({
          phrase_id: phraseId,
          progress: 0
        });
      }
      userProfile['langs'][lang] = phrases;
      return storage.setUserProfile(userProfile);
    };
    return {
      loadPage: function(template) {
        _nav = require('nav');
        return _loadPage(template);
      },
      refreshPage: function() {
        return _refreshPage();
      }
    };
  });

}).call(this);
